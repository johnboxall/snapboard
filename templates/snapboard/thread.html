{% extends "snapboard/base_forum.html" %}

{% load extras %}
{% load markup %}

{% block snapboard_main %}
    <div id="thread_rpc_msg_div" class="rpc_message">
        <!-- This DIV is for RPC feedback messages for the whole thread-->
    </div>
    <p>
        <span class="thread_menu">
            {% if user.is_staff %}
                <span>
                    <a id="csticky{{ thr.id }}" href="#" onClick="set_csticky('{{ thr.id }}');">
                        {{ thr.csticky|yesno:"unset,set" }} csticky
                    </a> 
                </span>
                &#149;
                <span>
                    <a id="gsticky{{ thr.id }}" href="#" onClick="set_gsticky('{{ thr.id }}');">
                        {{ thr.gsticky|yesno:"unset,set" }} gsticky
                    </a> 
                </span>
                &#149;
                <span>
                    <a id="close{{ thr.id }}" href="#" onClick="set_close('{{ thr.id }}');">
                        {{ thr.closed|yesno:"open,close" }} thread
                    </a> 
                </span>
            {% endif %}
            {% if user.is_authenticated %}
                &#149;
                <span>
                    <a id="watch{{ thr.id }}" href="#" onClick="set_watch('{{ thr.id }}');">
                        {{ watched|yesno:"don't," }} watch
                    </a> 
                </span>
            {% endif %}
        </span>
        <b style="font-size: large;">
            <a href="/snapboard/threads/category/{{ thr.category.id }}">{{ thr.category }}</a>:
            {{ thr.subject }}
        </b>
    </p>
    <br />

    {% include "snapboard/page_navigation.html" %}

    <div>
    <hr class="firstpost" />
    {% for post in post_page %}
        <div id="post_rpc_msg_div{{ post.id }}" class="rpc_message">
            <!-- This DIV is for RPC feedback messages for individual posts -->
        </div>
        <p class="post_header">
            <span class="post_menuright">
                {% ifequal post.user_id user.id %}
                <span title="Edit this post.  All revisions are saved!" class="popup">
                    <b><a href="#" onclick="toggle_edit('{{ post.id }}')">edit post</a></b>
                </span>
                &#149;
                {% endifequal %}
                {% if user.is_staff %}
                <span title="ADMIN: mark this post for censorship" class="popup">
                    <a id="censor{{ post.id }}" href="#" onClick="set_censor('{{ post.id }}');">
                        {{ post.censor|yesno:"uncensor,censor" }}
                    </a>
                </span>
                
                {% endif %}
                {% if user.is_authenticated %}
                <span title="Report this post for violation of forum policies." class="popup">
                    <a id="abuse{{ post.id }}" href="#" onClick="set_abuse('{{ post.id }}');">&#149; report abuse</a>
                </span>
                {% endif %}
            </span>

            <!-- [ICON] -->
            <b>
                <a href="#" onclick="toggle_post('{{ post.id }}');">
                    <span title="POPUP" class="popup">{{ post.user }}</span>
                </a>
            </b>

            <span class="timesince">
                {{ post.date|timesince }} ago
            </span>
            <span class="post_summary" style="display:none;" id="sum{{ post.id }}">:
                {{ post.text|post_summary:"30" }}
            </span>
        </p>

        <div style="display:block" id="post{{ post.id }}">


            <div class="post" style="display:block" id="post_text{{ post.id }}">
                {{ post.text|striptags|textile }}
            </div>

            {% ifequal post.user_id user.id %}
            <div style="display:none" id="post_edit{{ post.id }}">
                <form action="/snapboard/edit_post/{{ post.id }}/" method="POST">
                <b>All revisions of this post are stored and publicly viewable.</b>
                {{ post.get_edit_form.as_p }}
                <input type="submit" value="Update">
                </form>
            </div>
            {% endifequal %}

            {% if post.previous %}
            <span class="post_menuleft">
                <a href="#">This message has been revised</a>
            </span>
            <br />
            {% endif %}

        </div>
        <br />
        <hr class="postend" />
    {% endfor %} {# iterate through posts #}
    </div>

    {% include "snapboard/page_navigation.html" %}
    {% if not thr.closed and not page_next%}
        {% if user.is_authenticated %}
        <!-- div style="border: 1px solid #ccc; padding: 5px; background: #efe" -->
        <br />
        <form action="" method="POST">
            Got something to say?
            <br />
            {{ postform.as_p }}
            <input type="submit" value="Post">
        </form>
        {% else %}
        <p>You need to <a href="/login">sign in</a> to post messages.</p>
        {% endif %}
    {% endif %}
    {% if thr.closed %}
        <br />
        <p>This discussion has been closed by the staff.  You can no longer add posts.</p>
    {% endif %}

{% endblock %}
